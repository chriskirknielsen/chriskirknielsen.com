(()=>{(function(){let r=new(window.AudioContext||window.webkitAudioContext),A=[{note:"C",octave:1,keyQwerty:"A",keyAzerty:"Q"},{note:"C#",octave:1,keyQwerty:"W",keyAzerty:"Z"},{note:"D",octave:1,keyQwerty:"S",keyAzerty:"S"},{note:"D#",octave:1,keyQwerty:"E",keyAzerty:"E"},{note:"E",octave:1,keyQwerty:"D",keyAzerty:"D"},{note:"F",octave:1,keyQwerty:"F",keyAzerty:"F"},{note:"F#",octave:1,keyQwerty:"T",keyAzerty:"T"},{note:"G",octave:1,keyQwerty:"G",keyAzerty:"G"},{note:"G#",octave:1,keyQwerty:"Y",keyAzerty:"Y"},{note:"A",octave:2,keyQwerty:"H",keyAzerty:"H"},{note:"A#",octave:2,keyQwerty:"U",keyAzerty:"U"},{note:"B",octave:2,keyQwerty:"J",keyAzerty:"J"},{note:"C",octave:2,keyQwerty:"K",keyAzerty:"K"}],h=new Map,w=new Map,m=new Set,b="",i=!1,l=!1,E=!1;function M(){Array.from(document.querySelectorAll(".about-synth-slider, .about-synth-waveform-button, .about-synth-key")).forEach(e=>e.disabled=!1)}function T(e){return A.find(t=>(i?t.keyAzerty:t.keyQwerty)===e)||!1}function K(e,t){return A.find(n=>n.note===e&&n.octave===parseInt(t,10))||!1}function x(e){return`${e.note}${e.octave}`}function Q(e,t){return document.querySelector(`.about-synth-key[data-note="${e}"][data-octave="${t}"]`)||!1}function G(e){let t=e.getAttribute("data-note").trim().toUpperCase(),n=parseInt(e.getAttribute("data-octave"),10);return{note:t,octave:n}}function y(e,t=!1){let n=e.octave+(!t&&l?1:0);return{element:Q(e.note,n),note:e.note,octave:n}}function g(e){return e.key.toLowerCase()==="shift"}function N(){let e=document.getElementById("synth-waveform");switch(e?parseInt(e.value,10):0){default:case 1:return"sine";case 2:return"triangle";case 3:return"square";case 4:return"sawtooth"}}function F(){return{attack:Math.min(10,Math.max(1e-5,parseFloat(document.getElementById("synth-osc-attack").value||0)))/10,decay:Math.min(10,Math.max(1e-5,parseFloat(document.getElementById("synth-osc-decay").value||0)))/2,sustain:Math.min(10,Math.max(1e-5,parseFloat(document.getElementById("synth-osc-sustain").value||0)))*10,release:Math.min(10,Math.max(1e-5,parseFloat(document.getElementById("synth-osc-release").value||0))),filter:Math.min(100,Math.max(1e-5,parseFloat(document.getElementById("synth-osc-filter").value||0)))*10}}function S(e=null){if(e&&typeof e=="boolean"){i=e;return}let t=document.getElementById("about-synth-keyboard-layout-switch");if(!!t)return i=t.checked,t.setAttribute("aria-checked",i.toString()),i}function f(){let e=l?1:0;Array.from(document.querySelectorAll("[data-note]")).forEach(n=>{let a=n.querySelector(".about-synth-key-label"),o=n.getAttribute("data-note"),s=parseInt(n.getAttribute("data-octave"),10),c=K(o,s-e);if(!c){a.innerText="";return}let u=i?c.keyAzerty:c.keyQwerty;a.innerText=u})}function C(e="A",t=4){let a=0;switch(e){default:case"A":a=0;break;case"A#":case"Bb":a=1;break;case"B":a=2;break;case"C":a=3;break;case"C#":case"Db":a=4;break;case"D":a=5;break;case"D#":case"Eb":a=6;break;case"E":a=7;break;case"F":a=8;break;case"F#":case"Gb":a=9;break;case"G":a=10;break;case"G#":case"Ab":a=11;break}return a+=12*(t-4),440*Math.pow(2,a/12)}function I(e){if(!E)return;let t=N()||"sine",n=F(),a=r.createOscillator(),o=C(e.note,(e.octave||0)+1),s=1e-5,c=r.createGain(),u=r.createGain(),k=r.createGain(),p=r.createGain(),d=r.createBiquadFilter(),q=100;a.type=t,a.connect(c),c.gain.value=["sine","triangle"].includes(t)?1:.25,c.connect(u),u.gain.setValueAtTime(1e-5,r.currentTime),n.attack>s?u.gain.exponentialRampToValueAtTime(.9,r.currentTime+s+n.attack):u.gain.exponentialRampToValueAtTime(.9,r.currentTime+s),u.connect(k),k.gain.setValueAtTime(1,r.currentTime+n.attack),k.gain.exponentialRampToValueAtTime(n.sustain/100,r.currentTime+n.attack+n.decay),k.connect(p),p.connect(n.filter<=1e3?d:r.destination),n.filter<=1e3&&(d.type="lowpass",d.frequency.value=n.filter+q,d.Q.value=1,d.connect(r.destination)),Number.isFinite(o)&&(a.frequency.value=o),v(b);let B=x(e);e.element.setAttribute("aria-pressed","true"),h.set(B,{osc:a,release:p,envelope:n,threshold:s}),m.add(B),a.start()}function v(e){if(!e)return;e.element.setAttribute("aria-pressed","false");let t=x(e),n=h.get(t);if(!n)return;let a=n.osc,o=n.release,s=n.envelope,c=n.threshold;o.gain.setValueAtTime(.9,r.currentTime),o.gain.exponentialRampToValueAtTime(1e-5,r.currentTime+Math.max(s.release,c)),a&&(setTimeout(()=>{a.stop()},1e3*Math.max(s.release,c)),h.delete(t),m.delete(t))}function z(e,t,n){I({element:e,note:t,octave:n})}M(),S(),f(),document.addEventListener("click",e=>{let t=e.target.closest(".toggleswitch");if(!t)return!0;let n=t.querySelector(".toggleswitch-checkbox"),a=e.target.closest("[data-value]");if(!a)return!0;let o=a.getAttribute("data-value")==="true";return n.checked=o,n.dispatchEvent(new Event("change",{bubbles:!0})),e.preventDefault(),!1}),document.addEventListener("change",e=>{let t=e.target.closest(".toggleswitch-checkbox");!t||(i=t.checked,t.setAttribute("aria-checked",i.toString()),S(i),f())}),document.addEventListener("keydown",e=>{(g(e)||e.shiftKey)&&(l=!0,f())}),document.addEventListener("keyup",e=>{(g(e)||!e.shiftKey&&!g(e))&&(l=!1,f())}),document.addEventListener("mousedown",e=>{var t=e.target.closest("[data-note]");if(!!t)return e.preventDefault(),z(t,t.getAttribute("data-note"),parseInt(t.getAttribute("data-octave"),10)),b={element:t,note:t.getAttribute("data-note"),octave:parseInt(t.getAttribute("data-octave"),10)},!1},!1),document.addEventListener("mouseup",()=>v(b),!1),document.addEventListener("keydown",e=>{let t=e.key.toUpperCase();if(e.altKey||e.metaKey||e.ctrlKey||e.repeat)return;if(t==="ENTER"||t===" "){let o=e.target.closest("[data-note]");o&&z(o,o.getAttribute("data-note"),parseInt(o.getAttribute("data-octave"),10));return}let n=T(t);if(!n)return;let a=y(n);w.set(t,l),I(a)}),document.addEventListener("keyup",e=>{let t=e.key.toUpperCase();if(e.altKey||e.metaKey||e.ctrlKey)return;let n;if(t==="ENTER"||t===" "){let a=e.target.closest("[data-note]");a&&(n={element:a,note:a.getAttribute("data-note"),octave:parseInt(a.getAttribute("data-octave"),10)})}else{let a=T(t);if(!a)return;n=y(a);let o=w.get(t);o&&e.shiftKey===!1?(n.octave+=1,n=y(n,!0)):!o&&e.shiftKey===!0&&(n.octave-=1,n=y(n,!0))}v(n)},!1),window.addEventListener("blur",function(){Array.from(m).forEach(e=>{let t=e.slice(0,e.length-1),n=parseInt(e.slice(-1),10),o=K(t,n-(l?1:0)),s=y(o);v(s)})});let L=document.querySelector(".about-synth");new IntersectionObserver(function(e){e.forEach(t=>{E=t.isIntersecting})},{root:null,rootMargin:"20px",threshold:[0,.05,.1,.25,1]}).observe(L)})();})();
